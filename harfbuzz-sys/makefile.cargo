FLAGS = -fPIC

ifeq (wasm32-unknown-unknown,$(TARGET))
	WASI_SDK_ROOT ?= /opt/wasi-sdk
	CXX ?= $(WASI_SDK_ROOT)/bin/clang++
	CC ?= $(WASI_SDK_ROOT)/bin/clang
	AR ?= $(WASI_SDK_ROOT)/bin/llvm-ar
	RANLIB ?= $(WASI_SDK_ROOT)/bin/llvm-ranlib
else
ifneq ($(HOST),$(TARGET))
  CXX ?= $(TARGET)-g++
  CC ?= $(TARGET)-gcc
  AR ?= $(TARGET)-ar
else
  CXX ?= g++
  CC ?= gcc
  AR ?= ar
endif
endif

ifeq ($(DEBUG),true)
  FLAGS += -g
else
  FLAGS += -O2
endif

CONFIGURE_FLAGS = \
	--prefix=$(OUT_DIR) \
	--host=$(TARGET) \
	--enable-static \
	--disable-shared \
	--without-icu \
	--without-freetype \
	--without-glib

ifeq (armv7-linux-androideabi,$(TARGET))
	# Reset TARGET variable because armv7 target name used by Rust is not
	# the same as the target name needed for the CXX toolchain.
	TARGET = arm-linux-androideabi
	FLAGS += -march=armv7-a -mfpu=neon --target=$(TARGET)
endif

ifeq (wasm32-unknown-unknown,$(TARGET))
	# Reset TARGET variable because unknown system name used by Rust is not
	# the same as the target name needed for the CXX toolchain.
	TARGET = wasm32-unknown-none
  CONFIGURE_FLAGS += --with-coretext=no
	FLAGS += -DHB_NO_MT=1 -DHB_NO_PRAGMA_GCC_DIAGNOSTIC_ERROR=1
else
  CONFIGURE_FLAGS += --with-coretext=auto
endif

CFLAGS += $(FLAGS)
CXXFLAGS += $(FLAGS)

# Create a unique temporary build directory
BUILD_DIR := $(shell mktemp -d $(OUT_DIR)/rust_build.XXXXX)

all:
	# Copy source files to BUILD_DIR to avoid changing originals.
	cp -a $(CARGO_MANIFEST_DIR)/harfbuzz/* $(BUILD_DIR)
	# Touch in BUILD_DIR avoid regenerating files.
	$(MAKE) -f $(CARGO_MANIFEST_DIR)/makefile.touch touch HARFBUZZ="$(BUILD_DIR)"
	# Configure and build in BUILD_DIR, install from BUILD_DIR into OUT_DIR.
	cd $(BUILD_DIR) && \
	  ./configure $(CONFIGURE_FLAGS) CC="$(CC)" CXX="$(CXX)" AR="$(AR)" RANLIB="$(RANLIB)" CFLAGS="$(CFLAGS)" CXXFLAGS="$(CXXFLAGS)" CPPFLAGS="$(CPPFLAGS)" && \
	  make -j$(NUM_JOBS) && \
	  make install
	# Remove the no-longer-needed BUILD_DIR to save space.
	rm -rf $(BUILD_DIR)

.PHONY: all
